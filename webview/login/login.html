<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>SunLight Login</title>

  <meta name="mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <link rel="stylesheet" type="text/css" href="/resources/css/uikit.min.css">
</head>

<style>
  .sl-icon-back {
    background: white;
    border-radius: 12px;
    left: 8px;
    height: 40px;
    position: absolute;
    top: 11px;
    width: 40px;
  }
</style>
<style>
  body {
    background-image: url("/resources/img/login_bg.png");
    background-position: center center;
    background-repeat: no-repeat;
    background-size: cover;
  }
</style>

<body
  class="uk-cover-container uk-background-secondary uk-flex uk-flex-center uk-flex-middle uk-height-viewport uk-overflow-hidden uk-light"
  data-uk-height-viewport>
  <!-- overlay -->
  <div class="uk-position-cover uk-overlay-primary"></div>
  <!-- /overlay -->
  <div class="uk-width-medium uk-padding-small uk-position-z-index" uk-scrollspy="cls: uk-animation-fade" style>
    <!-- login -->
    <form class="toggle-class" id="login_form">
      <fieldset class="uk-fieldset">
        <div class="uk-margin-small">
          <div class="uk-inline uk-width-1-1">
            <span class="uk-form-icon uk-form-icon-flip" data-uk-icon="icon: user"></span>
            <input id="user_id" class="uk-input uk-border-pill" required placeholder="User ID" type="text">
          </div>
        </div>
        <div class="uk-margin-small">
          <div class="uk-inline uk-width-1-1">
            <span class="uk-form-icon uk-form-icon-flip" data-uk-icon="icon: lock"></span>
            <input id="password" class="uk-input uk-border-pill" required placeholder="{{i18n/password}}/Handover"
              type="password">
          </div>
        </div>

        {{#if enableRecaptcha}}
        <div class="g-recaptcha uk-margin-small" data-theme="dark" data-sitekey="{{siteKey}}"></div>
        {{/if}}

        <div class="uk-margin-small">
          <button type="button" class="uk-button uk-button-primary uk-border-pill uk-width-1-1"
            onclick="login()">{{i18n/login}}</button>
          {{#unless external}}
          <a id="external"
            class="uk-button uk-button-primary uk-border-pill uk-width-1-1 uk-margin-small">{{i18n/openInBrowser}}</a>
          {{/unless}}
        </div>

        <div class="uk-text-center">
          <a class="uk-link-reset uk-text-small toggle-class uk-margin-top"
            data-uk-toggle="target: .toggle-class; animation: uk-animation-fade">{{i18n/forgotPassword}}</a>
        </div>
      </fieldset>
    </form>
    <!-- /login -->

    <!-- recover password -->
    <form class="toggle-class" hidden>
      <fieldset class="uk-fieldset">
        <div class="uk-margin-small">
          <div class="uk-inline uk-width-1-1">
            <span class="uk-form-icon uk-form-icon-flip" data-uk-icon="icon: mail"></span>
            <input class="uk-input uk-border-pill" placeholder="{{i18n/email}}" required type="text">
          </div>
        </div>

        {{#if enableRecaptcha}}
        <div class="g-recaptcha uk-margin-small" data-theme="dark" data-sitekey="{{siteKey}}"></div>
        {{/if}}

        <div class="uk-margin-small">
          <button type="button" class="uk-button uk-button-primary uk-border-pill uk-width-1-1"
            onclick="recoverPassword()">{{i18n/send}}</button>
        </div>

        <div class="uk-text-center">
          <a class="uk-link-reset uk-text-small toggle-class uk-margin-small"
            data-uk-toggle="target: .toggle-class; animation: uk-animation-fade" hidden><span
              data-uk-icon="arrow-left"></span> {{i18n/backToLogin}}</a>
        </div>
      </fieldset>
    </form>
    <!-- /recover password -->
  </div>

  <div id="notice" class="uk-overlay uk-position-bottom uk-light" uk-scrollspy="cls: uk-animation-slide-bottom-medium"
    hidden>
    <h1>{{i18n/success}}</h1>
    <p>
      {{{i18n/successDescriptionLogin}}}
    </p>
  </div>

  <script type="text/javascript" src="/resources/js/jquery.min.js"></script>
  <script type="text/javascript" src="/resources/js/uikit.min.js"></script>
  <script type="text/javascript" src="/resources/js/uikit-icons.min.js"></script>
  <script type="text/javascript" src="/resources/js/common.js"></script>
  <script type="text/javascript" src="/resources/js/jsencrypt.min.js"></script>
  <script type="text/javascript" src='https://www.recaptcha.net/recaptcha/api.js'></script>
  <script type="">
    // fix error? o.O
    var headers = {{{headers}}}
    var recaptchaEnabled = {{{enableRecaptcha}}}
  </script>
  <script type="text/javascript">
    // RSA preparation
    var RSAEncrypt = new JSEncrypt()
    RSAEncrypt.setKey(`{{PublicKey}}`)
    if (window.history.length != 1) $("body").append('<div id="back"><a onclick="window.history.back()" class="uk-icon-button sl-icon-back" uk-icon="icon: arrow-left; ratio: 1.5"></a></div>')
    $("#external").attr("href", "native://browser?url=" + encodeURIComponent(window.location.href + "?user_id=&token=" + parseQueryString(headers.authorize).token))

    function login() {
      var userId = $("#user_id").val()
      var pass = $("#password").val()

      if (!checkUser(userId)) return sendNotification("{{i18n/userIdShouldBeInt}}", "warning")
      if (pass.length === 0) return sendNotification("{{i18n/passwordBlank}}", "warning")
      if (pass.length > 32) return sendNotification("{{i18n/passwordLimit}}", "warning")
      if (!checkPass(pass)) return sendNotification("{{i18n/passwordInvalidFormat}}", "warning")

      if (recaptchaEnabled === true) {
        var recaptchaResponse = grecaptcha.getResponse()
        if (recaptcha && recaptchaResponse.length === 0) return sendNotification("{{i18n/recaptchaFailed}}", "warning")
        grecaptcha.reset()
      }

      $.when(sendRequest({
        module: "{{{module}}}",
        action: "login",
        user_id: RSAEncrypt.encrypt(userId),
        password: RSAEncrypt.encrypt(xor(pass, parseQueryString(headers.authorize).token)),
        recaptcha: recaptchaResponse || "",
        timestamp: Math.floor(Date.now() / 1000)
      })).done(function (response) {
        if (response.error || response.maintenance || !response) return
        if ("{{{redirect}}}".length != 0) {
          window.location.replace(window.location.protocol + "//" + window.location.host + "/{{{redirect}}}")
        } else {
          $("#login_form, #buttons, #back").hide()
          $("#notice").removeAttr("hidden").show()
        }
      })
    }

    function recoverPassword() {
      sendNotification("TODO", "primary")
    }
  </script>
</body>

</html>