<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>SunLight WebView</title>

  <meta name="mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, user-scalable=no">

  <link rel="stylesheet" type="text/css" href="/resources/css/uikit.min.css">
  <link rel="stylesheet" type="text/css" href="/resources/css/perfect-scrollbar.css">
  <link rel="stylesheet" type="text/css" href="/resources/css/common.css">
</head>

<body>
  <div id="outer">
    <div id="inner">
      <div id="header">
        {{{header i18n/announce this}}}
      </div>

      <div id="body">
      </div>

      {{{changeLanguageModal}}}
    </div>
  </div>

  <script type="">
    var headers = {{{headers}}}
    var enableResize = true
  </script>
  <script type="text/javascript" src="/resources/js/uikit.min.js"></script>
  <script type="text/javascript" src="/resources/js/jquery.min.js"></script>
  <script type="text/javascript" src="/resources/js/common.js"></script>

  <script type="text/javascript" src="/resources/js/handlebars.runtime.min.js"></script>
  <script type="text/javascript" src="/resources/templates/announce-index.js"></script>
  
  <script type="text/javascript" src="/resources/js/uikit-icons.min.js"></script>
  <script type="text/javascript" src="/resources/js/perfect-scrollbar.min.js"></script>
  <script type="text/javascript" src="/resources/js/change-language.js"></script>
  <script>
    var announceTotal = 1 // Start from 1 so that we can load the list
    var loadAttempt = 0 // Just in case, in order not to overload the server
    var ps = new PerfectScrollbar('#body', { suppressScrollX: true }) 
    var announceTemplate = Handlebars.templates["announce-index"]

    $(document).ready(function () {
      loadNews(function () {
        // check if current url contains query string
        var queryString = window.location.href.split("?")[1]
        if (!queryString) return

        // if it is we check if it also contains 'id' element
        var queryObject = parseQueryString(queryString)
        if (!queryObject.id) return

        // send request to server to make sure this record is in the database
        checkIfExists(queryObject.id, function (result) {
          if (result != true) return

          function loadUntil() {
            if ($("#announce-" + queryObject.id).length != 0) {
              $('#body,html').animate({
                scrollTop: $("#announce-" + queryObject.id).offset().top
              }, 'slow')
              return
            }
            loadNews(loadUntil)
          }
          loadUntil()
        })
      })
    })
    $("#body").on('ps-y-reach-end', () => {
      loadNews()
    })

    function loadNews(callback) {
      if (loadAttempt > 3 || $(".uk-card-header").length === announceTotal) return
      let before = $(".uk-card-header").length
      $.when(sendRequest({
        module: "announce",
        action: "list",
        offset: parseInt($(".uk-card-header").length),
        timestamp: Math.floor(Date.now() / 1000)
      })).done(function (response) {
        announceTotal = response.response_data.total
        response.response_data.more = "{{{i18n/more}}}"
        $("#body").append(announceTemplate(response.response_data))
        // fix incorrect height on load
        //$("#body").height($(window).height() - $("#body").offset().top - 20) 
        ps.update()
        if (before === $(".uk-card-header").length) loadAttempt += 1
        else loadAttempt = 0
        if (callback) callback()
      })
    }

    function checkIfExists(announceId, callback) {
      $.when(sendRequest({
        module: "announce",
        action: "check",
        id: parseInt(announceId),
        timestamp: Math.floor(Date.now() / 1000)
      })).done(function (response) {
        callback(response.response_data)
      })
    }
  </script>
</body>

</html>